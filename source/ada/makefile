###############################################################################
#                                                                             #
#                                Make File                                    #
#                                                                             #
###############################################################################

SOLIS_TARGET := $(SOLIS_ROOT)/target
SOLIS_SOURCE := $(SOLIS_ROOT)/source
SOLIS_CONFIG := $(SOLIS_ROOT)/config
REPO_ENGINE := repo

EXE_DIR_SOLIS     := $(SOLIS_TARGET)/bin
LOG_DIR_SOLIS     := $(SOLIS_TARGET)/log
PIPE_DIR_SOLIS    := $(SOLIS_TARGET)/pipes

TABLES_OUTPUT := $(SOLIS_SOURCE)/ada/global/tables

C_CONSTANTS_OUTPUT := $(SOLIS_SOURCE)/ada/global/c_constants.ads
C_CONSTANTS_SOURCE := $(SOLIS_SOURCE)/c/c_constants.c
C_CONSTANTS_EXE    := $(SOLIS_TARGET)/bin/c_constants

TABLES := $(SOLIS_CONFIG)/repository/tables/table_*.xml
TERMS := $(SOLIS_CONFIG)/repository/terms/trm_*.xml
XSDS := $(SOLIS_CONFIG)/repository/*.xsd
TABLE_MAKE_FILE := $(SOLIS_SOURCE)/ada/global/tables/makefile.autogenerated

THE_TARGET := solis

.PHONY : all solis log SOLIS race_time ws dir rebuild

all : log

log :
	$(MAKE) $(THE_TARGET) 2>&1 | tee make.log



dir: $(EXE_DIR_SOLIS) $(LOG_DIR_SOLIS) $(PIPE_DIR_SOLIS)


$(TABLE_MAKE_FILE): $(REPO_ENGINE) $(TABLES) $(TERMS) $(XSDS) $(TABLES_OUTPUT)
	$(REPO_ENGINE) --table_makefile > $(TABLE_MAKE_FILE)
	cd $(SOLIS_SOURCE)/ada/global/tables && $(MAKE) -f $(TABLE_MAKE_FILE)

$(REPO_ENGINE) : $(TABLES_OUTPUT)
	gprbuild -p -P solis.gpr repo

$(EXE_DIR_SOLIS) :
	mkdir -p $(EXE_DIR_SOLIS)

$(LOG_DIR_SOLIS) :
	mkdir -p $(LOG_DIR_SOLIS)

#$(PIPE_DIR_SOLIS) :
#	mkdir -p $(PIPE_DIR_SOLIS)

$(TABLES_OUTPUT) :
	mkdir -p $(TABLES_OUTPUT)

#.PHONY : $(TARGET_ADA_INFO_SPEC)
#$(TARGET_ADA_INFO_SPEC):
#	$(SOLIS_SCRIPT)/bash/create_revision_info.bash $(TARGET_ADA_INFO_SPEC)

#$(EXE_DIR_SOLIS)
solis : $(C_CONSTANTS_OUTPUT) $(TABLE_MAKE_FILE) $(TARGET_ADA_INFO_SPEC)
	@echo "building on host $(HOSTNAME)"
	gprbuild -p -P solis

#$(C_CONSTANTS_EXE) : $(C_CONSTANTS_SOURCE) $(EXE_DIR_SOLIS)
#	gcc -o $(C_CONSTANTS_EXE) $(C_CONSTANTS_SOURCE)

#$(C_CONSTANTS_OUTPUT) : $(C_CONSTANTS_EXE)
#	$(C_CONSTANTS_EXE) > $(C_CONSTANTS_OUTPUT)

clean:
	cd $(SOLIS_SOURCE)/ada/global/tables && rm -f *
	rm -rf $(SOLIS_TARGET)/bin
	rm -rf $(SOLIS_TARGET)/objects

